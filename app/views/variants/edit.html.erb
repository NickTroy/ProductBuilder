
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/image-picker/0.2.4/image-picker.min.js"></script>
<link href='https://cdnjs.cloudflare.com/ajax/libs/image-picker/0.2.4/image-picker.min.css' rel='stylesheet' type='text/css'>
<style>
  .reel img {
    width: 400px !important;
    height: auto !important;

  }
  #three_sixty_image-reel {
    width: 575px !important;
    height: auto !important;
    text-align: center;
    margin: auto auto;
  }
  .image_picker_image {
    height: 200px;
  }
</style>
<script type="text/javascript">
$(document).ready(function(){
  Dropzone.autoDiscover = false;
  $("#product-variant-images").dropzone({
    url: "<%= product_variant_variant_images_url(:protocol => 'https', :variant_id => @variant.id) %>",
    // restrict image size to a maximum 1MB
    maxFilesize: 1,
    // changed the passed param to one accepted by
    // our rails app
    paramName: "image",
    previewsContainer: '.dropzone-previews',
    clickable: '.dropzone-previews',
    // show remove links on each image upload
    addRemoveLinks: true,
    success: function(file, response){
      // find the remove button link of the uploaded file and give it an id
      // based of the fileID response from the server
      $('.dropzone-previews').find('.dz-remove:last').attr('id', response.imageID);
      // add the dz-success class (the green tick sign)
      $('.dropzone-previews').addClass("dz-success");
	    
      $('.dz-remove:last').click(function(){
        var id = $(this).attr('id'); 
        // make a DELETE ajax request to delete the file
        $.ajax({
          type: 'POST',
          data: { _method: 'DELETE' },
          url: '<%= product_variant_variant_images_url(:variant_id => @variant.id, :protocol => 'https') %>/' + id,
          success: function(data){
            console.log(data.message);
          }
        });
        $('#selectImage option[value="'+ id +'"]').remove();
        $('#selectImage').imagePicker();
      })		
    },
    //when the remove button is clicked
    init: function(){
      var existingFiles = [];
        <% @variant_images.each_with_index do |image, index| %>
          existingFiles.push({ id: "<%= image.id %>"});
          this.emit("addedfile", existingFiles[<%= index %>]);
          this.emit("thumbnail", existingFiles[<%= index %>], "<%= image.image.url %>");
          $('.dropzone-previews').find('.dz-remove:last').attr('id', <%= image.id %>);
        <% end %>
      
      this.on("removedfile", function(file){
		      
      })
    }
		
  });	
	
  $('.dz-remove').click(function(){
    var id = $(this).attr('id'); 
    // make a DELETE ajax request to delete the file
    $.ajax({
      type: 'POST',
      data: { _method: 'DELETE' },
      url: '<%= product_variant_variant_images_url(:variant_id => @variant.id, :protocol => 'https') %>/' + id,
      success: function(data){
        console.log(data.message);
      }
    });
    $('#selectImage option[value="'+ id +'"]').remove();
    $('#selectImage').imagepicker();

  })

});
  
</script>
<script type="text/javascript">

$(document).ready(function(){
  <% if @shopify_variant.inventory_management.nil? %>
    $('.inventory_quantity').hide();
  <% end %>
  $('#inventory_management').on('change', function(){
    $('.inventory_quantity').toggle();
  });
  
  $('.assign_three_sixty_image').click(function(e){
    e.preventDefault();
    var three_sixty_image_id = $('.select_three_sixty_image').val();
    if (three_sixty_image_id != "0") {
      $.ajax({
        url: "<%= three_sixty_images_url(:protocol => 'https') %>/" + three_sixty_image_id + "/assign_to_variant",
        method: "POST",
        data: { 
          three_sixty_image_id: three_sixty_image_id,
          variant_id: <%= @variant.id %>
        },
        success: function(three_sixty_image_info){
          $('.reel').unreel();
          var first_plane_image = three_sixty_image_info["first_plane_image"]
          $('.reel').attr('src', first_plane_image);
          var images_names = three_sixty_image_info["images_names"];
          var images_path = three_sixty_image_info["images_path"];
          var frames = three_sixty_image_info["images_path"];
          var rotation_speed = three_sixty_image_info["rotation_speed"]
          var rotations_count = three_sixty_image_info["rotations_count"]
          var clockwise = three_sixty_image_info["clockwise"]
          var duration = rotations_count / rotation_speed * 10;
          $('.reel').reel({
            frames: images_names.count,
            speed: rotation_speed / 10,
            cw: clockwise,
            duration: duration,
            path: images_path + "/",
            images: images_names
          });
        }
      })  
    }
  });
  
  <% unless @variant.main_image_id.nil? %>
    var selected_image = <%= @variant.main_image_id %>;
    $("#selectImage").find('option[value="'+ selected_image +'"]').prop('selected',true);
  <% end %>
  $("#selectImage").imagepicker();

  <% unless @plane_images.nil? %>
    var images_names = "<%= @images_names %>";
    images_names = images_names.split(',');
    var rotation_speed = <%= @three_sixty_image.rotation_speed.to_f / 10 %>;
    var duration = <%= @three_sixty_image.rotations_count.to_f / @three_sixty_image.rotation_speed.to_f * 10 %>;
    var clockwise = <%= @three_sixty_image.clockwise.nil? ? false : @three_sixty_image.clockwise %>;
    $('.reel').reel({
      frames: <%= @plane_images.count %>,
      speed: rotation_speed,
      duration: duration,
      path: "<%= @images_path %>/",
      images: images_names,
      cw: clockwise
    });
  <% end %>
});
  
</script>
<div class="container">
  <%= form_for @variant, url: product_variant_path(:product_id => params[:product_id], :variant_id => @variant.id ) do |f| %>
    <div class="row">
      <div class="col-md-6 form-group">
        <%= f.label 'variant[sku]', "SKU (Stock Keeping Unit)" %>
        <%= f.text_field :sku, class: "form-control" %>
      </div>

      <div class="col-md-6 form-group">
        <%= f.label 'variant[price]', "Price" %>
        <%= f.text_field :price, class: "form-control" %>
      </div>
      
      <div class="col-md-6 form-group">
        <label for="invenotry_managment">
          Inventory Managment
        </label>
        <select id="inventory_management" class="form-control" name="inventory_management">
          <option value="shopify" <%= @shopify_variant.inventory_management == 'shopify' ? "selected" : "" %>>Shopify</option>
          <option value="blank" <%= @shopify_variant.inventory_management.nil? ? "selected" : "" %>>Blank</option>
        </select>
      </div>
      
      <div class="col-md-6 form-group inventory_quantity">
        <label for="invenotry_quantity">
          Inventory Quantity
        </label>
        <input id="inventory_quantity" class="form-control" type="number" name="inventory_quantity" value=<%= @shopify_variant.inventory_quantity %>>
      </div>
      
      <div class="col-md-6 form-group">
        <%= f.label 'variant[length]', "Length" %>
        <%= f.text_field :length, class: "form-control" %>
      </div>
      
      <div class="col-md-6 form-group">
        <%= f.label 'variant[height]', "Height" %>
        <%= f.text_field :height, class: "form-control" %>
      </div>
      
      <div class="col-md-6 form-group">
        <%= f.label 'variant[depth]', "Depth" %>
        <%= f.text_field :depth, class: "form-control" %>
      </div>
      
    </div>  
    <h2>
      Select main variant image
    </h2>
    <select class="image-picker show-html" id="selectImage" name="image_id">
      
      <% @variant_images.each_with_index do |img, i| %>
        <option data-img-src="<%= img.image.url(:medium) %>" value="<%= img.id %>"></option>
      <% end %>
    </select>

    <div class="variant-images-container">
      <div class="row">
        <div class="col-md-12">
          <h2>Upload product variant images</h2>
          <div class="dropzone-previews dropzone">
            <div class="dz-default dz-message"><span>Drop files here to upload</span>
            </div>
          </div>
        </div>
      </div><br>
    </div>

    <div class="three-sixty-images-container">
      <div class="row three_sixty_image_assignment">
        <div class="col-md-6">
          <label>Assign 3D image</label>
          <select class="form-control select_three_sixty_image">
            <option value="0">-Select 3D image-</option>
            <% @three_sixty_images.each do |three_sixty_image| %>
              <option value="<%= three_sixty_image.id %>">
                <span class="three_sixty_title">
                  <%= three_sixty_image.title %>
                </span>
              </option>  
            <% end %>
          </select>
        </div>
        <div class="col-md-6">
          <br>
          <button class="btn btn-info assign_three_sixty_image">
            Confirm 3D Image Assignment
          </button>
        </div>
      </div>
      <div class="row current_three_sixty_image">
        <div class="col-md-12">
          <div class="3d_image">
            <img src="<%= @first_plane_image %>" width="400" height="auto" class="reel" id="three_sixty_image">
          </div>
      </div>
      </div>
    </div>


    <div class="row">
      <div class="col-md-2">
        <%= f.submit "Save", :class => "btn btn-success" %>
      </div>
      <div class="col-md-2">
        <%= f.submit "Cancel", :class => 'btn btn-warning' %>
      </div>     
    </div>
<% end %>    
  <form id="product-variant-images" action="" method="post" name="product-images">
    <input id="image" style="display:none;" name="image" type="file">
  </form> 
</div>
